#CXX = clang-6.0
CXX = g++-7.3
PREFIX ?= /usr/local
CXXFLAGS += -fPIC -std=c++17 -O3 -DNDEBUG -I$(CASH_HOME)/include -Wall -Wextra -pedantic
#CXXFLAGS += -fPIC -std=c++17 -O0 -g -I$(CASH_HOME)/include -Wall -Wextra -pedantic
LDFLAGS += -shared -L$(CASH_HOME)/build/lib

# Target
TARGET_DIR := lib

PROJECT = libcash

SRCS = utils.cpp platform.cpp bitvector.cpp system.cpp lnodeimpl.cpp ioimpl.cpp \
       proxyimpl.cpp cdimpl.cpp litimpl.cpp regimpl.cpp memimpl.cpp selectimpl.cpp \
       aluimpl.cpp bindimpl.cpp assertimpl.cpp timeimpl.cpp printimpl.cpp \
       udfimpl.cpp lnode.cpp logic.cpp context.cpp compile.cpp simref.cpp \
       simjit.cpp deviceimpl.cpp simulatorimpl.cpp tracerimpl.cpp \
       verilogwriter.cpp firrtlwriter.cpp avalon_sim.cpp

OBJS := $(notdir $(SRCS:.cpp=.o))

all : $(TARGET_DIR) $(TARGET_DIR)/$(PROJECT).so

$(TARGET_DIR) :
  mkdir $(TARGET_DIR)

$(TARGET_DIR)/$(PROJECT).so : $(OBJS)
  $(CXX) $^ $(LDFLAGS) -o $@

avalon_sim.o : ../src/eda/altera/avalon_sim.cpp
  $(CXX) $(CXXFLAGS) -c $< -o $@

%.o : ../src/%.cpp
  $(CXX) $(CXXFLAGS) -c $< -o $@

.depend: $(SRCS)
  $(CXX) $(CXXFLAGS) -MM $^ > .depend;

clean:
  rm -rf $(PROJECT).so $(OBJS) lib *.gcda *.gcno .depend *~ *\#

ifneq ($(MAKECMDGOALS),clean)
    -include .depend
endif
